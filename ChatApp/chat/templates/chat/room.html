<!-- chat/templates/chat/room.html -->

{% extends 'base.html' %}

{% block title %}Chat Room - {{ room_name }}{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        Hello, <b>{{ user.username|capfirst|default:'Guest' }}!</b>
        {% if user.user_type == 'pro' %}
            (Pro)<sup>*</sup>
        {% else %}
            (Basic)<sup>*</sup>
        {% endif %}
        <br>
        <span style="color: #999; font-size: 0.8em;"><sup>*</sup>Pro users can create groups and add users, in addition to seeing entire chat history.</span><br><br>
        
        <b>Group :</b> {{room_name|capfirst}}<br>
        <b>Participants</b>
        <ul id="participant-list">
           {% for participant in participants %}
                <li>
                    <a href="{% url 'chat:direct_messages' %}?receiver={{ participant }}">{{ participant|capfirst }}</a>
                    {% if user.user_type == 'pro' and participant != request.user %}
                        <form action="{% url 'chat:remove_user_from_room' room_name participant.username %}" method="POST" style="display:inline;" onsubmit="return confirmDelete();">
                            {% csrf_token %}
                            <input type="submit" value="X" style="color: red; background: none; border: none; cursor: pointer; font-size: 12px;">
                        </form>
                    {% endif %}
                </li>
            {% empty %}
                <li>No other participants.</li>
            {% endfor %}
        </ul>

        {% if user.user_type == 'pro' %}
        <b>Invite</b> User to the group.
        <form method="POST" action="{% url 'chat:invite_to_room' room_name %}">
            {% csrf_token %}
            <input type="text" name="username" placeholder="Enter username to invite" required>
            <input type="submit" value="Invite">
        </form>
        {% endif %}
        {% if messages %}
            <br>
                {% for message in messages %}
                    {{ message }}<br>
                {% endfor %}
        {% endif %}
        <br>

        <textarea id="chat-log" cols="70" rows="15" readonly></textarea><br>
        <div class="chat-input-container">
            <input id="chat-message-input" type="text" size="50">
            <input id="chat-message-submit" type="button" value="Send">
        </div>
        
        {{ room_name|json_script:"room-name" }}
        <a href="{% url 'users:dashboard' %}">Dashboard</a>
        <a href="#" onclick="logout()">Logout</a>&nbsp;
    {% else %}
        <h5>You can access this page only if you are logged in.</h5>
        <a href="{% url 'users:dashboard' %}">Dashboard</a>
    {% endif %}
    
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        let chatSocket = null;  // Store the WebSocket connection reference

        function connectToChat() {
            if(!chatSocket) {
                chatSocket = new WebSocket(
                    'ws://'
                    + window.location.host
                    + '/ws/chat/'
                    + roomName
                    + '/'
                );
            }

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
        
                // This should handle messages from other users
                const { username = "Unknown User", message = "No message", timestamp = "Unknown time" } = data;
                
                // Check if messages are present
                if (data.messages) {
                    data.messages.forEach(msg => {
                        const { username, message, timestamp } = msg;
                        document.querySelector('#chat-log').value += `${timestamp} ${username}: ${message}\n`;
                    });
                } else {
                    const { username = "Unknown User", message = "No message", timestamp = "Unknown time" } = data;
                    document.querySelector('#chat-log').value += `${timestamp} ${username}: ${message}\n`;
                }
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed. Reconnecting...');
                chatSocket = null;  // Clear the reference
                setTimeout(connectToChat, 2000); // Reconnect after 2 seconds
            };
        }

        connectToChat();
        
        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input'); Â  

            var messageInput = messageInputDom.value.trim();  // remove leading or trailing whitespaces
            if (messageInput) {  // Only send message if there's valid input
                chatSocket.send(JSON.stringify({
                message: messageInput,
                username: '{{ request.user.username|capfirst }}'
                }));
                messageInputDom.value = '';
            }
        };
    </script>
    <script>
        function logout() {
            // Create a form element
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "users:logout" %}';
        
            // Create a hidden input field for the CSRF token
            var csrfTokenInput = document.createElement('input');
            csrfTokenInput.type = 'hidden';
            csrfTokenInput.name = 'csrfmiddlewaretoken';
            csrfTokenInput.value = '{{ csrf_token }}';
        
            // Append the CSRF token input to the form
            form.appendChild(csrfTokenInput);
        
            // Append the form to the document body
            document.body.appendChild(form);
        
            // Submit the form
            form.submit();
        }
    </script>
    <script>
        function confirmDelete() {
            return confirm("Are you sure you want to remove this user from the group?");
        }
    </script>
    
{% endblock %}