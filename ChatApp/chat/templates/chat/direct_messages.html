{% extends 'base.html' %}

{% block content %}
    {% if user.is_authenticated %}
        Hello, <b>{{ user.username|capfirst|default:'Guest' }}!</b>
        {% if user.user_type == 'pro' %}
            (Pro)<sup>*</sup>
        {% else %}
            (Basic)<sup>*</sup>
        {% endif %}
        <br>
        <span style="color: #999; font-size: 0.8em;"><sup>*</sup>Pro users can create groups and add users, in addition to seeing entire chat history.</span><br><br>

        {% if current_receiver %}
            messaging with: <b>{{ current_receiver.username|capfirst }}</b><br><br>
        
            <textarea id="message-log" cols="70" rows="20" readonly></textarea><br>
            <div class="message-input-container">
                <input id="message-input" type="text" size="50" placeholder="Type your message...">
                <input id="message-submit" type="button" value="Send">
            </div>
        {% endif %}

        <!-- Message Template -->
        <div id="message-template" style="display: none;">
            <span class="timestamp"></span> | <b class="username"></b>: <span class="message-content"></span>
            <button class="delete-message-button" style="color: red; background: none; border: none; cursor: pointer;">X</button>
            <br>
        </div>

        <a href="#" onclick="logout()">Logout</a>&nbsp;
        <a href="{% url 'users:dashboard' %}">Dashboard</a>
    {% else %}
        <h5>You can access this page only if you are logged in.</h5>
        <a href="{% url 'users:dashboard' %}">Dashboard</a>
    {% endif %}

<script>
    const messageLog = document.querySelector('#message-log'); // Declare messageLog globally
    const receiverSelect = document.querySelector('#receiver-select');
    let currentReceiver = '{{ current_receiver.username }}';

    // WebSocket connection
    const receiver = '{{ current_receiver.username }}'; // Make sure this is set correctly in your template
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/direct_messages/' + receiver + '/'
    );


    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log(data.messages)
        if (data.messages) {
                data.messages.forEach(message => {
                    const { timestamp, username, message: messageText } = message;
                    const capitalizedUsername = username.charAt(0).toUpperCase() + username.slice(1);
                    messageLog.value += `${timestamp} ${capitalizedUsername}: ${messageText}\n`;
                });
        }
        else {
            const { message, sender, timestamp } = data;
            console.log(data)
            const capitalizedSender = sender.charAt(0).toUpperCase() + sender.slice(1);
            messageLog.value += `${timestamp} ${capitalizedSender}: ${message}\n`;
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#message-input').focus();
    document.querySelector('#message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#message-submit').click();
        }
    };

    document.querySelector('#message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#message-input');

        var messageInput = messageInputDom.value.trim();  // remove leading or trailing whitespaces
        if (messageInput) {  // Only send message if there's valid input
            chatSocket.send(JSON.stringify({
                message: messageInput,
                'receiver': currentReceiver
            }));
            messageInputDom.value = '';
        }
    };
</script>
<script>
    function logout() {
        // Create a form element
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "users:logout" %}';
    
        // Create a hidden input field for the CSRF token
        var csrfTokenInput = document.createElement('input');
        csrfTokenInput.type = 'hidden';
        csrfTokenInput.name = 'csrfmiddlewaretoken';
        csrfTokenInput.value = '{{ csrf_token }}';
    
        // Append the CSRF token input to the form
        form.appendChild(csrfTokenInput);
    
        // Append the form to the document body
        document.body.appendChild(form);
    
        // Submit the form
        form.submit();
    }
</script>

{% endblock %}